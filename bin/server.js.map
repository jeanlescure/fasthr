{"version":3,"file":"server.js","sources":["../server.ts"],"sourcesContent":["import fastify from 'fastify';\nimport { PassThrough } from 'stream';\n\nconst server = fastify({\n  logger: true\n});\n\nconst defaults = {\n  directory: process.cwd(),\n  port: 3000,\n  livePort: 35729,\n};\n\nexport default async (options) => {\n  const {\n    directory,\n    port,\n    livePort,\n  }: any = {\n    ...defaults,\n    ...options,\n  };\n\n  server.register(require('fastify-static'), {\n    root: directory,\n  });\n\n  server.addHook('onSend', async (request, reply, payload: any) => {\n    if (\n      (payload as any).filename\n      && (/.html$/).test((payload as any).filename)\n    ) {\n      let newPayload = '';\n      await (\n        new Promise(\n          resolve => (\n            payload as PassThrough\n          )\n          .on('data', (chunk) => newPayload += chunk)\n          .on('finish', resolve)\n        )\n      );\n\n      newPayload = newPayload.replace(\n          '</body>',\n          `<script>\n          document.write('<script src=\"http://' + (location.host || 'localhost').split(':')[0] +\n          ':${livePort}/livereload.js?snipver=1\"></' + 'script>')\n        </script></body>`\n      );\n\n      reply.header('content-length', Buffer.from(newPayload).length);\n\n      return newPayload;\n    }\n\n    return payload;\n  });\n\n  try {\n    await server.listen(port);\n  } catch (err) {\n    server.log.error(err);\n    process.exit(1);\n  }\n};\n"],"names":["fastify"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA,IAAM,MAAM,GAAGA,2BAAO,CAAC;IACrB,MAAM,EAAE,IAAI;CACb,CAAC,CAAC;AAEH,IAAM,QAAQ,GAAG;IACf,SAAS,EAAE,OAAO,CAAC,GAAG,EAAE;IACxB,IAAI,EAAE,IAAI;IACV,QAAQ,EAAE,KAAK;CAChB,CAAC;AAEF,gBAAe,UAAO,OAAO;;;;;gBACrB,2BAKD,QAAQ,GACR,OAAO,CACX,EANC,SAAS,eAAA,EACT,IAAI,UAAA,EACJ,QAAQ,cAAA,CAIR;gBAEF,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,gBAAgB,CAAC,EAAE;oBACzC,IAAI,EAAE,SAAS;iBAChB,CAAC,CAAC;gBAEH,MAAM,CAAC,OAAO,CAAC,QAAQ,EAAE,UAAO,OAAO,EAAE,KAAK,EAAE,OAAY;;;;;sCAEvD,OAAe,CAAC,QAAQ;uCACtB,CAAC,QAAQ,EAAE,IAAI,CAAE,OAAe,CAAC,QAAQ,CAAC,CAAA,EAD7C,wBAC6C;gCAEzC,eAAa,EAAE,CAAC;gCACpB,sBACE,IAAI,OAAO,CACT,UAAA,OAAO,IAAI,OACT,OACD;yCACA,EAAE,CAAC,MAAM,EAAE,UAAC,KAAK,IAAK,OAAA,YAAU,IAAI,KAAK,GAAA,CAAC;yCAC1C,EAAE,CAAC,QAAQ,EAAE,OAAO,CAAC,GAAA,CACvB,GACF;;gCARD,SAQC,CAAC;gCAEF,YAAU,GAAG,YAAU,CAAC,OAAO,CAC3B,SAAS,EACT,8HAEI,QAAQ,0EACG,CAClB,CAAC;gCAEF,KAAK,CAAC,MAAM,CAAC,gBAAgB,EAAE,MAAM,CAAC,IAAI,CAAC,YAAU,CAAC,CAAC,MAAM,CAAC,CAAC;gCAE/D,sBAAO,YAAU,EAAC;oCAGpB,sBAAO,OAAO,EAAC;;;qBAChB,CAAC,CAAC;;;;gBAGD,qBAAM,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,EAAA;;gBAAzB,SAAyB,CAAC;;;;gBAE1B,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,KAAG,CAAC,CAAC;gBACtB,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;;;;;KAEnB;;;;"}