{"version":3,"file":"server.js","sources":["../server.ts"],"sourcesContent":["import fastify from 'fastify';\nimport { PassThrough } from 'stream';\n\nconst defaults = {\n  dir: process.cwd(),\n  port: 3000,\n  livePort: 35729,\n  address: '0.0.0.0',\n  quiet: false,\n};\n\nexport default async (options) => {\n  const {\n    dir,\n    port,\n    livePort,\n    address,\n    quiet,\n  }: any = {\n    ...defaults,\n    ...options,\n  };\n\n  const server = fastify({\n    logger: !quiet,\n  });\n\n  server.register(require('fastify-static'), {\n    root: dir,\n  });\n\n  server.addHook('onSend', async (request, reply, payload: any) => {\n    if (\n      (payload as any).filename\n      && (/.html$/).test((payload as any).filename)\n    ) {\n      let newPayload = '';\n      await (\n        new Promise(\n          resolve => (\n            payload as PassThrough\n          )\n          .on('data', (chunk) => newPayload += chunk)\n          .on('finish', resolve)\n        )\n      );\n\n      newPayload = newPayload.replace(\n          '</body>',\n          `<script>\n          document.write('<script src=\"http://' + (location.host || 'localhost').split(':')[0] +\n          ':${livePort}/livereload.js?snipver=1\"></' + 'script>')\n        </script></body>`\n      );\n\n      reply.header('content-length', Buffer.from(newPayload).length);\n\n      return newPayload;\n    }\n\n    return payload;\n  });\n\n  try {\n    await server.listen(port, address, () => {\n      console.log(`ðŸ”¥ Fast Hot Reload is running on http://${address}:${port}`);\n    });\n  } catch (err) {\n    server.log.error(err);\n    process.exit(1);\n  }\n};\n"],"names":["fastify"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA,IAAM,QAAQ,GAAG;IACf,GAAG,EAAE,OAAO,CAAC,GAAG,EAAE;IAClB,IAAI,EAAE,IAAI;IACV,QAAQ,EAAE,KAAK;IACf,OAAO,EAAE,SAAS;IAClB,KAAK,EAAE,KAAK;CACb,CAAC;AAEF,cAAe,UAAO,OAAO;;;;;gBACrB,2BAOD,QAAQ,GACR,OAAO,CACX,EARC,GAAG,SAAA,EACH,IAAI,UAAA,EACJ,QAAQ,cAAA,EACR,OAAO,aAAA,EACP,KAAK,WAAA,CAIL;gBAEI,MAAM,GAAGA,2BAAO,CAAC;oBACrB,MAAM,EAAE,CAAC,KAAK;iBACf,CAAC,CAAC;gBAEH,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,gBAAgB,CAAC,EAAE;oBACzC,IAAI,EAAE,GAAG;iBACV,CAAC,CAAC;gBAEH,MAAM,CAAC,OAAO,CAAC,QAAQ,EAAE,UAAO,OAAO,EAAE,KAAK,EAAE,OAAY;;;;;sCAEvD,OAAe,CAAC,QAAQ;uCACtB,CAAC,QAAQ,EAAE,IAAI,CAAE,OAAe,CAAC,QAAQ,CAAC,CAAA,EAD7C,wBAC6C;gCAEzC,eAAa,EAAE,CAAC;gCACpB,sBACE,IAAI,OAAO,CACT,UAAA,OAAO,IAAI,OACT,OACD;yCACA,EAAE,CAAC,MAAM,EAAE,UAAC,KAAK,IAAK,OAAA,YAAU,IAAI,KAAK,GAAA,CAAC;yCAC1C,EAAE,CAAC,QAAQ,EAAE,OAAO,CAAC,GAAA,CACvB,GACF;;gCARD,SAQC,CAAC;gCAEF,YAAU,GAAG,YAAU,CAAC,OAAO,CAC3B,SAAS,EACT,8HAEI,QAAQ,0EACG,CAClB,CAAC;gCAEF,KAAK,CAAC,MAAM,CAAC,gBAAgB,EAAE,MAAM,CAAC,IAAI,CAAC,YAAU,CAAC,CAAC,MAAM,CAAC,CAAC;gCAE/D,sBAAO,YAAU,EAAC;oCAGpB,sBAAO,OAAO,EAAC;;;qBAChB,CAAC,CAAC;;;;gBAGD,qBAAM,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,OAAO,EAAE;wBACjC,OAAO,CAAC,GAAG,CAAC,uDAA2C,OAAO,SAAI,IAAM,CAAC,CAAC;qBAC3E,CAAC,EAAA;;gBAFF,SAEE,CAAC;;;;gBAEH,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,KAAG,CAAC,CAAC;gBACtB,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;;;;;KAEnB;;;;"}